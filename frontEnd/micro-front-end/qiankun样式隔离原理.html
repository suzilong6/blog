<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>qiankun样式隔离原理 | 苏子龙 · 博客</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="苏子龙 · 博客">
    
    <link rel="preload" href="/blog/assets/css/0.styles.419553f3.css" as="style"><link rel="preload" href="/blog/assets/js/app.eae75af0.js" as="script"><link rel="preload" href="/blog/assets/js/2.e9c94859.js" as="script"><link rel="preload" href="/blog/assets/js/45.164f07d7.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.5842acd0.js"><link rel="prefetch" href="/blog/assets/js/11.c6c6402a.js"><link rel="prefetch" href="/blog/assets/js/12.f8db295f.js"><link rel="prefetch" href="/blog/assets/js/13.f41421a2.js"><link rel="prefetch" href="/blog/assets/js/14.f8c1aa89.js"><link rel="prefetch" href="/blog/assets/js/15.1e44bfc7.js"><link rel="prefetch" href="/blog/assets/js/16.91917a19.js"><link rel="prefetch" href="/blog/assets/js/17.93d46e57.js"><link rel="prefetch" href="/blog/assets/js/18.3125fe39.js"><link rel="prefetch" href="/blog/assets/js/19.c8fe9491.js"><link rel="prefetch" href="/blog/assets/js/20.ad82005a.js"><link rel="prefetch" href="/blog/assets/js/21.b913de9c.js"><link rel="prefetch" href="/blog/assets/js/22.df9f0353.js"><link rel="prefetch" href="/blog/assets/js/23.09f5b07d.js"><link rel="prefetch" href="/blog/assets/js/24.eb9dacb8.js"><link rel="prefetch" href="/blog/assets/js/25.f084a058.js"><link rel="prefetch" href="/blog/assets/js/26.877d1528.js"><link rel="prefetch" href="/blog/assets/js/27.ab6e6b17.js"><link rel="prefetch" href="/blog/assets/js/28.524f13e8.js"><link rel="prefetch" href="/blog/assets/js/29.e0ae414e.js"><link rel="prefetch" href="/blog/assets/js/3.177c913a.js"><link rel="prefetch" href="/blog/assets/js/30.986d87a3.js"><link rel="prefetch" href="/blog/assets/js/31.c2ec4851.js"><link rel="prefetch" href="/blog/assets/js/32.f8fd5341.js"><link rel="prefetch" href="/blog/assets/js/33.a15cf5d8.js"><link rel="prefetch" href="/blog/assets/js/34.505b855d.js"><link rel="prefetch" href="/blog/assets/js/35.b1d661b8.js"><link rel="prefetch" href="/blog/assets/js/36.a2c1d2ff.js"><link rel="prefetch" href="/blog/assets/js/37.0039bec6.js"><link rel="prefetch" href="/blog/assets/js/38.07d0887d.js"><link rel="prefetch" href="/blog/assets/js/39.163d2b21.js"><link rel="prefetch" href="/blog/assets/js/4.8639ffa7.js"><link rel="prefetch" href="/blog/assets/js/40.a05328c9.js"><link rel="prefetch" href="/blog/assets/js/41.a5aba0f5.js"><link rel="prefetch" href="/blog/assets/js/42.242ee510.js"><link rel="prefetch" href="/blog/assets/js/43.44c363b4.js"><link rel="prefetch" href="/blog/assets/js/44.fbd7cde0.js"><link rel="prefetch" href="/blog/assets/js/46.de7d5210.js"><link rel="prefetch" href="/blog/assets/js/47.cc9a7551.js"><link rel="prefetch" href="/blog/assets/js/48.b1e838dd.js"><link rel="prefetch" href="/blog/assets/js/49.0b46d62a.js"><link rel="prefetch" href="/blog/assets/js/5.e4119d2d.js"><link rel="prefetch" href="/blog/assets/js/50.ccb600bf.js"><link rel="prefetch" href="/blog/assets/js/51.8882ff0e.js"><link rel="prefetch" href="/blog/assets/js/52.4d0e319d.js"><link rel="prefetch" href="/blog/assets/js/53.7f4a6a13.js"><link rel="prefetch" href="/blog/assets/js/54.3c55f774.js"><link rel="prefetch" href="/blog/assets/js/55.63d87f74.js"><link rel="prefetch" href="/blog/assets/js/56.e02a4e4c.js"><link rel="prefetch" href="/blog/assets/js/6.633b083c.js"><link rel="prefetch" href="/blog/assets/js/7.4e92fea2.js"><link rel="prefetch" href="/blog/assets/js/8.635bebe6.js"><link rel="prefetch" href="/blog/assets/js/9.71bf3d06.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.419553f3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">苏子龙 · 博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/frontEnd/html/本地存储.html" class="nav-link">
  html
</a></li><li class="dropdown-item"><!----> <a href="/blog/frontEnd/JavaScript/闭包.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/blog/frontEnd/webpack/从0到1搭建一个企业级Vue3脚手架.html" class="nav-link">
  webpack
</a></li><li class="dropdown-item"><!----> <a href="/blog/frontEnd/engineering/" class="nav-link">
  前端工程化
</a></li><li class="dropdown-item"><!----> <a href="/blog/frontEnd/micro-front-end/" class="nav-link router-link-active">
  微前端
</a></li><li class="dropdown-item"><!----> <a href="/blog/frontEnd/visualization.html" class="nav-link">
  可视化
</a></li></ul></div></div><div class="nav-item"><a href="/blog/backEnd/" class="nav-link">
  后端
</a></div><div class="nav-item"><a href="/blog/network/" class="nav-link">
  网络
</a></div><div class="nav-item"><a href="/blog/database/" class="nav-link">
  数据库
</a></div><div class="nav-item"><a href="/blog/operations/" class="nav-link">
  运维
</a></div><div class="nav-item"><a href="/blog/dataStructure/" class="nav-link">
  数据结构
</a></div><div class="nav-item"><a href="/blog/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/blog/designMode/" class="nav-link">
  设计模式
</a></div><div class="nav-item"><a href="/blog/fundamentalsOfComputer/" class="nav-link">
  计算机基础
</a></div><div class="nav-item"><a href="/blog/other/" class="nav-link">
  其他
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/frontEnd/html/本地存储.html" class="nav-link">
  html
</a></li><li class="dropdown-item"><!----> <a href="/blog/frontEnd/JavaScript/闭包.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/blog/frontEnd/webpack/从0到1搭建一个企业级Vue3脚手架.html" class="nav-link">
  webpack
</a></li><li class="dropdown-item"><!----> <a href="/blog/frontEnd/engineering/" class="nav-link">
  前端工程化
</a></li><li class="dropdown-item"><!----> <a href="/blog/frontEnd/micro-front-end/" class="nav-link router-link-active">
  微前端
</a></li><li class="dropdown-item"><!----> <a href="/blog/frontEnd/visualization.html" class="nav-link">
  可视化
</a></li></ul></div></div><div class="nav-item"><a href="/blog/backEnd/" class="nav-link">
  后端
</a></div><div class="nav-item"><a href="/blog/network/" class="nav-link">
  网络
</a></div><div class="nav-item"><a href="/blog/database/" class="nav-link">
  数据库
</a></div><div class="nav-item"><a href="/blog/operations/" class="nav-link">
  运维
</a></div><div class="nav-item"><a href="/blog/dataStructure/" class="nav-link">
  数据结构
</a></div><div class="nav-item"><a href="/blog/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/blog/designMode/" class="nav-link">
  设计模式
</a></div><div class="nav-item"><a href="/blog/fundamentalsOfComputer/" class="nav-link">
  计算机基础
</a></div><div class="nav-item"><a href="/blog/other/" class="nav-link">
  其他
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog/frontEnd/micro-front-end/qiankun沙箱原理.html" class="sidebar-link">沙箱</a></li><li><a href="/blog/frontEnd/micro-front-end/qiankun样式隔离原理.html" class="active sidebar-link">qiankun样式隔离原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frontEnd/micro-front-end/qiankun样式隔离原理.html#shadow-dom" class="sidebar-link">Shadow DOM</a></li><li class="sidebar-sub-header"><a href="/blog/frontEnd/micro-front-end/qiankun样式隔离原理.html#scopedcss" class="sidebar-link">scopedCSS</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="qiankun样式隔离原理"><a href="#qiankun样式隔离原理" class="header-anchor">#</a> qiankun样式隔离原理</h1> <p>当我们在使用qiankun框架，从文档中我们可以发现调用start方法有两个非常有意思参数：</p> <p>strictStyleIsolation：表示开启严格的样式隔离模式。这种模式下 qiankun 会为每个微应用的容器包裹上一个 shadow dom 节点，从而确保微应用的样式不会对全局造成影响。</p> <p>experimentalStyleIsolation：qiankun 会改写子应用所添加的样式为所有样式规则增加一个特殊的选择器规则来限定其影响范围，因此改写后的代码会表达类似为如下结构：</p> <div class="language-css line-numbers-mode"><pre class="language-css"><code><span class="token selector">// 假设应用名是 react16
.app-main</span> <span class="token punctuation">{</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">div[data-qiankun-react16] .app-main</span> <span class="token punctuation">{</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><a href="https://qiankun.umijs.org/zh/api#startopts" target="_blank" rel="noopener noreferrer">qiankun文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>那么让我们学习一下这两种样式隔离的原理</p> <h2 id="shadow-dom"><a href="#shadow-dom" class="header-anchor">#</a> Shadow DOM</h2> <p><a href="https://developer.mozilla.org/zh-CN/docs/Web/Web_Components/Using_shadow_DOM" target="_blank" rel="noopener noreferrer">关于 Shadow DOM 请查看mdn<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>qiankun源码：src/loader.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">/**
 * 创建微应用容器
 * @param appContent 微应用 html 字符串
 * @param strictStyleIsolation 是否启用严格样式隔离，也就是是否开启 Shadow DOM
 * @param scopedCSS 是否为css添加作用域。其实就是 experimentalStyleIsolation。但是 strictStyleIsolation 和 scopedCSS 不能同时开启
 * @param appInstanceId 微应用名称
 * @returns 
 */</span>
<span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span>
  appContent<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  strictStyleIsolation<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
  scopedCSS<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
  appInstanceId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> HTMLElement <span class="token punctuation">{</span>
  <span class="token keyword">const</span> containerElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  containerElement<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> appContent<span class="token punctuation">;</span>
  <span class="token comment">// appContent总是用单数div包装</span>
  <span class="token keyword">const</span> appElement <span class="token operator">=</span> containerElement<span class="token punctuation">.</span>firstChild <span class="token keyword">as</span> HTMLElement<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>strictStyleIsolation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// supportShadowDOM 当前环境是否支持 Shadow DOM</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>supportShadowDOM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token string">'[qiankun]: As current browser not support shadow dom, your strictStyleIsolation configuration will be ignored!'</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 创建 Shadow DOM，并将innerHTML插入到Shadow DOM下</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> innerHTML <span class="token punctuation">}</span> <span class="token operator">=</span> appElement<span class="token punctuation">;</span>
      appElement<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> shadow<span class="token operator">:</span> ShadowRoot<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>appElement<span class="token punctuation">.</span>attachShadow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        shadow <span class="token operator">=</span> appElement<span class="token punctuation">.</span><span class="token function">attachShadow</span><span class="token punctuation">(</span><span class="token punctuation">{</span> mode<span class="token operator">:</span> <span class="token string">'open'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// createShadowRoot是在最初的规范中提出的，但后来被弃用</span>
        shadow <span class="token operator">=</span> <span class="token punctuation">(</span>appElement <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createShadowRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      shadow<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> innerHTML<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 作用域 css</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>scopedCSS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 给微应用打上标记</span>
    <span class="token keyword">const</span> attr <span class="token operator">=</span> appElement<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>css<span class="token punctuation">.</span>QiankunCSSRewriteAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>attr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      appElement<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>css<span class="token punctuation">.</span>QiankunCSSRewriteAttr<span class="token punctuation">,</span> appInstanceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取微应用 style 标签集合</span>
    <span class="token keyword">const</span> styleNodes <span class="token operator">=</span> appElement<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 为每一个 style 添加作用域</span>
    <span class="token function">forEach</span><span class="token punctuation">(</span>styleNodes<span class="token punctuation">,</span> <span class="token punctuation">(</span>stylesheetElement<span class="token operator">:</span> HTMLStyleElement<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      css<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>appElement<span class="token operator">!</span><span class="token punctuation">,</span> stylesheetElement<span class="token punctuation">,</span> appInstanceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> appElement<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><p>Shadow DOM其实是比较简单的，只需要在主应用加载子应用创建dom容器时，在dom容器上添加 Shadow DOM，然后将子应用挂载在Shadow DOM下即可</p> <h3 id="shadow-dom-缺点"><a href="#shadow-dom-缺点" class="header-anchor">#</a> Shadow DOM 缺点：</h3> <p>比如说element ui 的 弹框组件，会将弹窗的Dom插入到 document.body 下，而不是 shadow dom。因此会失去样式隔离的保护，导致样式冲突。</p> <p>基于 ShadowDOM 的严格样式隔离并不是一个可以无脑使用的方案，大部分情况下都需要接入应用做一些适配后才能正常在 ShadowDOM 中运行起来（比如 react 场景下需要解决这些 <a href="https://github.com/facebook/react/issues/10422" target="_blank" rel="noopener noreferrer">问题<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，使用者需要清楚开启了 <code>strictStyleIsolation</code> 意味着什么。后续 qiankun 会提供更多官方实践文档帮助用户能快速的将应用改造成可以运行在 ShadowDOM 环境的微应用。</p> <h2 id="scopedcss"><a href="#scopedcss" class="header-anchor">#</a> scopedCSS</h2> <p>从上面代码的 42 行开始，其实就是 作用域隔离的入口了</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">/**
 * 调用ScopedCSS类的process方法，为style元素的选择器添加作用域
 * @param appWrapper 微应用
 * @param stylesheetElement style元素
 * @param appName 微应用名称
 * @returns 
 */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> process <span class="token operator">=</span> <span class="token punctuation">(</span>
  appWrapper<span class="token operator">:</span> HTMLElement<span class="token punctuation">,</span>
  stylesheetElement<span class="token operator">:</span> HTMLStyleElement <span class="token operator">|</span> HTMLLinkElement<span class="token punctuation">,</span>
  appName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 惰性单例模式：确保在整个应用中只会存在一个ScopedCSS实例，且只有需要的时候才会创建</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>processor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    processor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScopedCSS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 暂时不支持 link 方式</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>stylesheetElement<span class="token punctuation">.</span>tagName <span class="token operator">===</span> <span class="token string">'LINK'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'Feature: sandbox.experimentalStyleIsolation is not support for link element yet.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> mountDOM <span class="token operator">=</span> appWrapper<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mountDOM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 标签名</span>
  <span class="token keyword">const</span> tag <span class="token operator">=</span> <span class="token punctuation">(</span>mountDOM<span class="token punctuation">.</span>tagName <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">&amp;&amp;</span> stylesheetElement<span class="token punctuation">.</span>tagName <span class="token operator">===</span> <span class="token string">'STYLE'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// prefix：前缀。example：div[data-qiankun=&quot;vue&quot;]</span>
    <span class="token keyword">const</span> prefix <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>QiankunCSSRewriteAttr<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>appName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token comment">// 入口：调用ScopedCSS类的process方法</span>
    processor<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>stylesheetElement<span class="token punctuation">,</span> prefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ScopedCSS</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> ModifiedTag <span class="token operator">=</span> <span class="token string">'Symbol(style-modified-qiankun)'</span><span class="token punctuation">;</span> <span class="token comment">// 防止重复给style元素处理的标识</span>

  <span class="token keyword">private</span> sheet<span class="token operator">:</span> StyleSheet<span class="token punctuation">;</span> <span class="token comment">// style 元素的</span>

  <span class="token keyword">private</span> swapNode<span class="token operator">:</span> HTMLStyleElement<span class="token punctuation">;</span> <span class="token comment">// style 元素</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> styleNode <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将元素插入到body下</span>
    <span class="token function">rawDocumentBodyAppend</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">,</span> styleNode<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>swapNode <span class="token operator">=</span> styleNode<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sheet <span class="token operator">=</span> styleNode<span class="token punctuation">.</span>sheet<span class="token operator">!</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sheet<span class="token punctuation">.</span>disabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">process</span><span class="token punctuation">(</span>styleNode<span class="token operator">:</span> HTMLStyleElement<span class="token punctuation">,</span> prefix<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 防止重复处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ScopedCSS<span class="token punctuation">.</span>ModifiedTag <span class="token keyword">in</span> styleNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// styleNode.textContent: style 标签的样式文本</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>styleNode<span class="token punctuation">.</span>textContent <span class="token operator">!==</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 通过 style元素 获取到 cssRules，然后重写选择器</span>
      <span class="token keyword">const</span> textNode <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>styleNode<span class="token punctuation">.</span>textContent <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 为什么这里要把 textNode 插入到 swapNode 中，处理完后又从 swapNode 清除呢？</span>
      <span class="token comment">// 原因很简单：swapNode是在body下的，如果不将textNode插入到swapNode中，那么获取 sheet 属性就会为 null，只有 textNode 在文档流中，我们才能获取 sheet，这应该是 api 的限制吧！！！</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>swapNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>textNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> sheet <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>swapNode<span class="token punctuation">.</span>sheet <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">;</span> <span class="token comment">// https://developer.mozilla.org/zh-CN/docs/Web/API/StyleSheet</span>
      <span class="token keyword">const</span> rules <span class="token operator">=</span> <span class="token generic-function"><span class="token function">arrayify</span><span class="token generic class-name"><span class="token operator">&lt;</span>CSSRule<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>sheet<span class="token operator">?.</span>cssRules <span class="token operator">??</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// https://developer.mozilla.org/zh-CN/docs/Web/API/CSSRule</span>
      <span class="token keyword">const</span> css <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">rewrite</span><span class="token punctuation">(</span>rules<span class="token punctuation">,</span> prefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 将添加了作用域的css字符串覆盖原有内容</span>
      styleNode<span class="token punctuation">.</span>textContent <span class="token operator">=</span> css<span class="token punctuation">;</span>

      <span class="token comment">// 从swapNode元素上清除，你懂的，防止下次代码走到这里的时候把已经处理好的样式又处理了一遍</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>swapNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>textNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 给元素打上标识，防止重复处理</span>
      <span class="token punctuation">(</span>styleNode <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">[</span>ScopedCSS<span class="token punctuation">.</span>ModifiedTag<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">// 有时候style元素中的样式内容还未加载，通过MutationObserver监听元素变化，对其进行处理，处理逻辑同上</span>
    <span class="token keyword">const</span> mutator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mutations<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mutations<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> mutation <span class="token operator">=</span> mutations<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>ScopedCSS<span class="token punctuation">.</span>ModifiedTag <span class="token keyword">in</span> styleNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mutation<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'childList'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 跟上面的逻辑一样</span>
          <span class="token keyword">const</span> sheet <span class="token operator">=</span> styleNode<span class="token punctuation">.</span>sheet <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> rules <span class="token operator">=</span> <span class="token generic-function"><span class="token function">arrayify</span><span class="token generic class-name"><span class="token operator">&lt;</span>CSSRule<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>sheet<span class="token operator">?.</span>cssRules <span class="token operator">??</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> css <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">rewrite</span><span class="token punctuation">(</span>rules<span class="token punctuation">,</span> prefix<span class="token punctuation">)</span><span class="token punctuation">;</span>

          styleNode<span class="token punctuation">.</span>textContent <span class="token operator">=</span> css<span class="token punctuation">;</span>
          <span class="token punctuation">(</span>styleNode <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">[</span>ScopedCSS<span class="token punctuation">.</span>ModifiedTag<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 因为在删除节点时，观察者将被删除，我们不需要手动创建清理函数</span>
    <span class="token comment">// see https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver/disconnect</span>
    mutator<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>styleNode<span class="token punctuation">,</span> <span class="token punctuation">{</span> childList<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 重写选择器
   * @param rules 
   * @param prefix 
   * @returns 
   */</span>
  <span class="token keyword">private</span> <span class="token function">rewrite</span><span class="token punctuation">(</span>rules<span class="token operator">:</span> CSSRule<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> prefix<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> css <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>

    <span class="token comment">// https://developer.mozilla.org/zh-CN/docs/Web/API/CSSRule#%E7%B1%BB%E5%9E%8B%E5%B8%B8%E9%87%8F</span>
    rules<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span>rule<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> RuleType<span class="token punctuation">.</span><span class="token constant">STYLE</span><span class="token operator">:</span> <span class="token comment">// 最常见的一种规则。 selector { prop1: val1; prop2: val2; }</span>
          css <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ruleStyle</span><span class="token punctuation">(</span>rule <span class="token keyword">as</span> CSSStyleRule<span class="token punctuation">,</span> prefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> RuleType<span class="token punctuation">.</span><span class="token constant">MEDIA</span><span class="token operator">:</span> <span class="token comment">// https://developer.mozilla.org/zh-CN/docs/Web/API/CSSMediaRule</span>
          css <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ruleMedia</span><span class="token punctuation">(</span>rule <span class="token keyword">as</span> CSSMediaRule<span class="token punctuation">,</span> prefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> RuleType<span class="token punctuation">.</span><span class="token constant">SUPPORTS</span><span class="token operator">:</span> <span class="token comment">// https://developer.mozilla.org/zh-CN/docs/Web/API/CSSSupportsRule</span>
          css <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ruleSupport</span><span class="token punctuation">(</span>rule <span class="token keyword">as</span> CSSSupportsRule<span class="token punctuation">,</span> prefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
          <span class="token comment">// 其他类型直接原样返回</span>
          css <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>rule<span class="token punctuation">.</span>cssText<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> css<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 对普通的css规则进行重写, 最最最核心的地方，其实就是用正则表达式进行选择器的替换</span>
  <span class="token comment">// handle case:</span>
  <span class="token comment">// .app-main {}</span>
  <span class="token comment">// html, body {}</span>
  <span class="token keyword">private</span> <span class="token function">ruleStyle</span><span class="token punctuation">(</span>rule<span class="token operator">:</span> CSSStyleRule<span class="token punctuation">,</span> prefix<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> rootSelectorRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">((?:[^\w\-.#]|^)(body|html|:root))</span><span class="token regex-delimiter">/</span><span class="token regex-flags">gm</span></span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> rootCombinationRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(html[^\w{[]+)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">gm</span></span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> selector <span class="token operator">=</span> rule<span class="token punctuation">.</span>selectorText<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token punctuation">{</span> cssText <span class="token punctuation">}</span> <span class="token operator">=</span> rule<span class="token punctuation">;</span>
    <span class="token comment">// 防止影响全局样式</span>
    <span class="token comment">// handle html { ... }</span>
    <span class="token comment">// handle body { ... }</span>
    <span class="token comment">// handle :root { ... }</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>selector <span class="token operator">===</span> <span class="token string">'html'</span> <span class="token operator">||</span> selector <span class="token operator">===</span> <span class="token string">'body'</span> <span class="token operator">||</span> selector <span class="token operator">===</span> <span class="token string">':root'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> cssText<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>rootSelectorRE<span class="token punctuation">,</span> prefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// handle html body { ... }</span>
    <span class="token comment">// handle html &gt; body { ... }</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rootCombinationRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span>selectorText<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> siblingSelectorRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(html[^\w{]+)(\+|~)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">gm</span></span><span class="token punctuation">;</span>

      <span class="token comment">// since html + body is a non-standard rule for html</span>
      <span class="token comment">// transformer will ignore it</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>siblingSelectorRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span>selectorText<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cssText <span class="token operator">=</span> cssText<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>rootCombinationRE<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 对标签样式前缀进行重写</span>
    <span class="token comment">// handle grouping selector, a,span,p,div { ... }</span>
    cssText <span class="token operator">=</span> cssText<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[\s\S]+{</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span>selectors<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
      selectors<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(^|,\n?)([^,]+)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span>item<span class="token punctuation">,</span> p<span class="token punctuation">,</span> s<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// handle div,body,span { ... }</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rootSelectorRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> item<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>rootSelectorRE<span class="token punctuation">,</span> <span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// do not discard valid previous character, such as body,html or *:not(:root)</span>
            <span class="token keyword">const</span> whitePrevChars <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">','</span><span class="token punctuation">,</span> <span class="token string">'('</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">&amp;&amp;</span> whitePrevChars<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// replace root selector with prefix</span>
            <span class="token keyword">return</span> prefix<span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>p<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>s<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^ *</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> cssText<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 对媒体查询相关进行重写</span>
  <span class="token comment">// handle case:</span>
  <span class="token comment">// @media screen and (max-width: 300px) {}</span>
  <span class="token keyword">private</span> <span class="token function">ruleMedia</span><span class="token punctuation">(</span>rule<span class="token operator">:</span> CSSMediaRule<span class="token punctuation">,</span> prefix<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> css <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">rewrite</span><span class="token punctuation">(</span><span class="token function">arrayify</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span>cssRules<span class="token punctuation">)</span><span class="token punctuation">,</span> prefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">@media </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>rule<span class="token punctuation">.</span>conditionText <span class="token operator">||</span> rule<span class="token punctuation">.</span>media<span class="token punctuation">.</span>mediaText<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> {</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>css<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 对 @supports 相关进行重写，@supports 请查阅文档https://developer.mozilla.org/zh-CN/docs/Web/CSS/@supports</span>
  <span class="token comment">// handle case:</span>
  <span class="token comment">// @supports (display: grid) {}</span>
  <span class="token keyword">private</span> <span class="token function">ruleSupport</span><span class="token punctuation">(</span>rule<span class="token operator">:</span> CSSSupportsRule<span class="token punctuation">,</span> prefix<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> css <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">rewrite</span><span class="token punctuation">(</span><span class="token function">arrayify</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span>cssRules<span class="token punctuation">)</span><span class="token punctuation">,</span> prefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> `<span class="token decorator"><span class="token at operator">@</span><span class="token function">supports</span></span> $<span class="token punctuation">{</span>rule<span class="token punctuation">.</span>conditionText <span class="token operator">||</span> rule<span class="token punctuation">.</span>cssText<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'{'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>$<span class="token punctuation">{</span>css<span class="token punctuation">}</span><span class="token punctuation">}</span>`<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br></div></div><h3 id="总结"><a href="#总结" class="header-anchor">#</a> 总结：</h3> <p>qiankun 对于 scopedCSS 目前只支持 style 标签， 不支持link标签。</p> <p>核心代码是 ScopedCSS 这个类。</p> <p>核心原理：通过 style 元素获取其 cssRules，遍历cssRules，通过正则表达式替换其选择器，以达到 css 作用域的效果。其实原理并不难，难的是对一些边缘情况的处理，这一点框架处理得非常到位。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/frontEnd/micro-front-end/qiankun沙箱原理.html" class="prev">
        沙箱
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.eae75af0.js" defer></script><script src="/blog/assets/js/2.e9c94859.js" defer></script><script src="/blog/assets/js/45.164f07d7.js" defer></script>
  </body>
</html>
